name: Deploy MSI

on:
  workflow_run:
    workflows: [Build]
    types: [completed]
  
env:
  CARGO_TERM_COLOR: always

jobs:

  on-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - uses: actions/checkout@v3

    - name: Set up cargo cache
      uses: actions/cache@v3
      continue-on-error: false
      with:
        path: |
          target/
        key: windows-target-${{ hashFiles('**/Cargo.lock') }}
        enableCrossOsArchive: true
        restore-keys: windows-target-

    - name: Get version
      run: echo "CV_VERSION=$(cargo get version)" >> $env:GITHUB_ENV
      
    - name: copy file via ssh password
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SIRSONIC_HOST }}
        username: ${{ secrets.SIRSONIC_USER }}
        key: ${{ secrets.SIRSONIC_KEY }}
        port: ${{ secrets.SIRSONIC_PORT }}
        source: "target/wix/chrome_valet-$CV_VERSION-x86_64.msi"
        target: "dl.sirsonic.com/releases/chrome_valet"
        strip_components: 3
        
  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - run: echo 'Build workflow failed'
